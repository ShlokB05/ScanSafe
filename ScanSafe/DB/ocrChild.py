common_ingredients = [ 'salt', 'sugar', 'water', 'flour', 'enriched wheat flour', 'all-purpose flour', 'bleached wheat flour', 'corn syrup', 'high fructose corn syrup', 'dextrose', 'maltodextrin', 'fructose', 'glucose', 'canola oil', 'soybean oil', 'palm oil', 'vegetable oil', 'coconut oil', 'sunflower oil', 'olive oil', 'corn oil', 'cottonseed oil', 'palm kernel oil', 'hydrogenated vegetable oil', 'partially hydrogenated soybean oil', 'shortening', 'margarine', 'butter', 'lard', 'sea salt', 'iodized salt', 'brown sugar', 'powdered sugar', 'confectioners sugar', 'molasses', 'honey', 'maple syrup', 'agave nectar', 'invert sugar', 'rice syrup', 'cane sugar', 'raw sugar', 'turbinado sugar',  'milk', 'skim milk', 'nonfat milk', 'whole milk', 'cream', 'buttermilk', 'whey', 'whey protein concentrate', 'milk protein concentrate', 'nonfat dry milk', 'dry milk', 'condensed milk', 'evaporated milk', 'cheese', 'cheddar cheese', 'mozzarella cheese', 'parmesan cheese', 'cream cheese', 'cultured milk', 'yogurt', 'sour cream', 'sodium caseinate', 'calcium caseinate', 'lactose', 'eggs', 'egg whites', 'egg yolks', 'dried egg', 'yeast', 'baking soda', 'sodium bicarbonate', 'baking powder', 'monocalcium phosphate', 'sodium acid pyrophosphate', 'corn starch', 'modified corn starch', 'potato starch', 'modified food starch', 'tapioca starch', 'xanthan gum', 'guar gum', 'gelatin', 'pectin', 'carrageenan', 'locust bean gum', 'carob bean gum', 'cellulose gum', 'cellulose gel', 'sodium alginate', 'agar-agar', 'gum arabic', 'arrowroot', 'spices', 'black pepper', 'white pepper', 'cayenne pepper', 'red pepper', 'chili powder', 'paprika', 'smoked paprika', 'mustard', 'mustard flour', 'mustard seed', 'dijon mustard', 'garlic powder', 'onion powder', 'dehydrated garlic', 'dehydrated onion', 'celery salt', 'celery seed', 'cinnamon', 'nutmeg', 'cloves', 'ginger', 'turmeric', 'cumin', 'coriander', 'allspice', 'oregano', 'basil', 'rosemary', 'thyme', 'parsley', 'dill weed', 'sage', 'marjoram', 'bay leaf', 'annatto', 
                      'poppy seeds', 'sesame seeds', 'fennel', 'cardamom', 'anise', 'star anise', 'citric acid', 'lactic acid', 'ascorbic acid', 'malic acid', 'fumaric acid', 'tartaric acid', 'vinegar', 'apple cider vinegar', 'distilled vinegar', 'balsamic vinegar', 'sodium benzoate', 'potassium sorbate', 'calcium propionate', 'sorbic acid', 'sodium citrate', 'potassium citrate', 'calcium carbonate', 'sodium phosphate', 'disodium phosphate', 'monosodium phosphate', 'trisodium phosphate', 'sodium tripolyphosphate', 'potassium phosphate', 'calcium lactate', 'sodium lactate', 'calcium chloride', 'potassium chloride', 'bha', 'bht', 'tbhq', 'tocopherols', 'vitamin e', 'edta', 'disodium edta', 'rosemary extract',  'soy lecithin', 'soy protein isolate', 'soy protein concentrate', 'textured soy protein', 'hydrolyzed soy protein', 'hydrolyzed corn protein', 'hydrolyzed wheat protein', 'wheat gluten', 'peanuts', 'peanut butter', 'peanut oil', 'almonds', 'walnuts', 'pecans', 'cashews', 'pistachios', 'macadamia nuts', 'hazelnuts', 'soybeans', 'lentils', 'chickpeas', 'garbanzo beans', 'black beans', 'kidney beans', 'pinto beans', 'navy beans', 'lima beans', 'peas', 'green peas', 'corn', 'cornmeal', 'oats', 'rolled oats', 'oat fiber', 'oat bran', 'wheat', 'whole wheat flour', 'wheat bran', 'wheat germ', 'rice', 'brown rice', 'white rice', 'wild rice', 'rice flour', 'rice bran', 'barley', 'malted barley extract', 'rye', 'rye flour', 'quinoa', 'millet', 'sorghum', 'semolina', 'couscous', 'buckwheat', 'tomatoes', 'tomato paste', 'tomato puree', 'diced tomatoes', 'sun-dried tomatoes', 'tomato powder', 'onions', 'garlic', 'potatoes', 'potato flour', 'dehydrated potatoes', 'carrots', 'celery', 'bell peppers', 'green bell peppers', 'red bell peppers', 'jalapeno peppers', 'mushrooms', 'spinach', 'broccoli', 'cauliflower', 'cabbage', 'cucumbers', 'pickles', 'olives', 'black olives', 'green olives', 'corn', 'sweet corn', 'beets', 'pumpkin', 'sweet potatoes', 'zucchini', 'eggplant', 'artichoke hearts', 'asparagus',  'apples', 'apple juice concentrate', 'applesauce', 'dried apples', 'oranges', 'orange juice concentrate', 'lemon juice', 'lemon juice concentrate', 'lemon zest', 'lime juice', 'lime juice concentrate', 'grapes', 'grape juice concentrate', 'raisins', 'strawberries', 'blueberries', 'raspberries', 'cranberries', 'dried cranberries', 'cherries', 'peach', 'pears', 'pineapple', 'pineapple juice concentrate', 'bananas', 'banana puree', 'mangoes', 'mango puree', 'avocado', 'dates', 
                      'figs', 'prunes', 'apricots', 'coconut', 'shredded coconut', 'coconut cream', 'coconut milk', 'beef', 'beef stock', 'beef fat', 'pork', 'bacon', 'ham', 'sausage', 'chicken', 'chicken broth', 'chicken fat', 'turkey', 'turkey broth', 'fish', 'tuna', 'salmon', 'anchovies', 'shrimp', 'crab', 'clams', 'clam juice', 
                        'natural flavor', 'artificial flavor', 'vanilla extract', 'vanillin', 'almond extract', 'peppermint oil', 'yeast extract', 'autolyzed yeast extract', 'smoke flavor', 'mesquite smoke flavor', 'natural smoke flavor', 'worcestershire sauce', 'soy sauce', 'tamari', 'teriyaki sauce', 'hydrolyzed yeast extract', 'disodium inosinate', 'disodium guanylate', 
                        'monoglycerides', 'diglycerides', 'polysorbate 60', 'polysorbate 80', 'sorbitan monostearate', 'glycerin', 'propylene glycol', 'datem', 'sodium stearoyl lactylate', 'calcium stearoyl lactylate',  'aspartame', 'sucralose', 'acesulfame potassium', 'saccharin', 'stevia', 'reb a', 'monk fruit extract', 'erythritol', 'xylitol', 'sorbitol', 'mannitol', 'isomalt', 'maltitol', 'polydextrose',  'caramel color', 'annatto extract', 'beta-carotene', 'turmeric oleoresin', 'paprika oleoresin', 'red 40', 'yellow 5', 'yellow 6', 'blue 1', 'blue 2', 'red 3', 'titanium dioxide', 'cochineal extract', 'carmine', 'beet powder', 'grape skin extract', 'fruit juice color', 'vegetable juice color', 
                        'vitamin a palmitate', 'vitamin c', 'vitamin d3', 'vitamin b12', 'vitamin b6', 'thiamin mononitrate', 'riboflavin', 'niacinamide', 'folic acid', 'biotin', 'pantothenic acid', 'calcium pantothenate', 'reduced iron', 'ferrous sulfate', 'zinc oxide', 'calcium phosphate', 'tricalcium phosphate', 'magnesium phosphate', 'potassium iodide',  'chocolate', 'semisweet chocolate', 'bittersweet chocolate', 'milk chocolate', 'white chocolate',
                        'cocoa', 'cocoa processed with alkali', 'dutch cocoa', 'cocoa butter', 'chocolate liquor', 'caffeine', 'taurine', 'l-carnitine', 'inositol', 'glucuronolactone', 'ginseng extract', 'ginkgo biloba', 'alcohol', 'brandy', 'wine', 'rum', 'bourbon', 'coffee', 'espresso', 'tea', 'green tea extract', 'tapioca syrup', 'carnauba wax', 'beeswax', 'confectioners glaze', 'shellac', 'gelatin', 'collagen', 'protein isolate', 'micellar casein', 'heavy cream', 'almond butter', 'cashew butter',
                        'sunflower butter', 'tahini', 'tara gum','almond flour', 'coconut flour', 'cassava flour', 'psyllium husk', 'chia seeds', 'hemp seeds', 'pumpkin seeds', 'pomegranate juice', 'acai', 'goji berry', 'kombucha', 'apple cider', 'capers', 'horseradish', 'wasabi', 'sriracha', 'chipotle peppers', 'adobo sauce', 'miso', 'seaweed', 'nori', 'kefir', 'buttermilk powder', 'sour cream powder', 'cheese powder', 'onion flakes', 'minced onion', 'garlic salt', 'onion salt', 'celery powder', 'chives', 'scallions', 'leeks', 'shallots', 'truffle oil', 'truffles', 'saffron', 'vanilla bean', 'maple flavor', 'butter flavor', 'sodium metabisulfite', 'potassium metabisulfite', 'sulfur dioxide', 'enzymes', 'amylase', 'protease',"ingredients", 'lipase', 'lactase', 'invertase' ]

from ScanSafe.DB.ocr import Main
from rapidfuzz import process, fuzz
import re

IMG_PATH = "/Users/shlokbohra/Desktop/ScanSafe/DB/Perfect.png"

BlackList = ["milk", "cheese"] #would be the sql thing where I get the user profile and check, hardcoded for now

filter = ['J',',','a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z', ";", "to","ensure","freshness","amount","adds","add","of","and","or","qf", "to ensure", "to protect", "to preserve", "to maintain", "to improve",
  "to enhance", "to help", "to prevent", "to reduce", "to keep", "to provide",
  "to add", "to support", "to stabilize", "to thicken", "to color", "to flavor",
  "to sweeten", "to fortify", "to enrich", "to leaven", "to emulsify",
  "to condition", "to retain", "to control", "to inhibit", "to extend",
  "to prevent caking", "to prevent sticking",
  "ensure freshness", "for freshness", "for flavor", "for color", "for texture",
  "for quality", "for stability", "for preservation",
  "added for freshness", "added for color", "added for flavor",
  "contains less than", "contains 2% or less", "less than 2%",
  "may contain", "processed in a facility", "manufactured in a facility",
  "natural and artificial flavors","to","ensure","freshness","protect","preserve","maintain","improve","enhance",
  "help","prevent","reduce","keep","provide","support","stabilize","thicken",
  "color","flavor","sweeten","fortify","enrich","leaven","emulsify","condition",
  "retain","control","inhibit","extend","added","for","with","and","or","may",
  "contain","contains","less","than","amount","qf","negligible","ensure","quality"]

CommonItems = set(common_ingredients) #set for faster matching


def CleaningOCR(Ingredients):
    if not Ingredients:
        return []
    else:
        IngredientsCleaned = re.split(r'[,;:]',Ingredients[0], maxsplit=0)
        IngredientsCleaned = [Ingredient.lower().strip(" ,;:.()[]{}") for Ingredient in IngredientsCleaned if Ingredient not in filter]
        IngredientsCleaned = [Ingredient for Ingredient in IngredientsCleaned if Ingredient]
    return IngredientsCleaned


def settingIngredients(IngredientList: list, VerifiedIngredients, For_Review_due_to_len, Items_to_fuzzy_match): 
    for item in IngredientList:
        if item in CommonItems:
            VerifiedIngredients.append(item)
        elif(len(item) < 3):
            For_Review_due_to_len.append(item)
        else: 
            Items_to_fuzzy_match.append(item)



def FuzzyMatchingIngredients(FuzzyMatch : list, VerifiedIngredients, Ingredients_Not_Supported_In_DataBase):
    if not FuzzyMatch: 
        return []
    for item in FuzzyMatch:
        ClosestMatch = process.extractOne(item, common_ingredients, score_cutoff=90)
        if ClosestMatch:
            VerifiedIngredients.append(ClosestMatch[0])
        else:
            Ingredients_Not_Supported_In_DataBase.append(item)


def ProcessFile(ImgPath):
    Ingredients_ = Main(ImgPath)
    CleanIngredients = CleaningOCR(Ingredients=Ingredients_)

    For_Review_due_to_len = []
    VerifiedIngredients = []
    Ingredients_Not_Supported_In_DataBase = []
    Items_to_fuzzy_match = []

    settingIngredients(CleanIngredients, VerifiedIngredients, For_Review_due_to_len, Items_to_fuzzy_match)
    print("vf: ", VerifiedIngredients)
    print("itemsToFuzzy: ", Items_to_fuzzy_match)

    FuzzyClean = []
    for phrase in Items_to_fuzzy_match:
        if(len(phrase) >= 3): FuzzyClean.append(phrase.split(" "))
    FuzzyMatchingIngredients(Items_to_fuzzy_match, VerifiedIngredients, Ingredients_Not_Supported_In_DataBase)

    TwoWordChunks = []
    for phrase in Items_to_fuzzy_match:
        words = re.findall(r"[a-z0-9]+", phrase.lower())   
        for i in range(len(words) - 1):     
                TwoWordChunks.append(words[i] + " " + words[i+1])

    
    #FuzzyMatchingIngredients(FuzzyClean, VerifiedIngredients, Ingredients_Not_Supported_In_DataBase)
    FuzzyMatchingIngredients(TwoWordChunks, VerifiedIngredients, Ingredients_Not_Supported_In_DataBase)



    if "ingredients" in VerifiedIngredients: VerifiedIngredients.remove("ingredients")
    VerifiedIngredients = [Ing for Ing in VerifiedIngredients if Ing not in filter]
    Final = list(set(VerifiedIngredients))
    Ingredients_Not_Supported_In_DataBase = [x for x in Ingredients_Not_Supported_In_DataBase if ((x) and (str(x).strip().lower() not in filter))]

    return {
        "raw_text": " ".join(Ingredients_) if Ingredients_ else "",
        "tokens": CleanIngredients,
        "VerifiedIngredients": Final,
        "unknown": Ingredients_Not_Supported_In_DataBase,
        "For_Review_due_to_len": For_Review_due_to_len,
    }




